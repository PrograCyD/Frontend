<div class="admin-management-container">
  <header class="header">
    <h1>
      <span class="material-icons">settings</span>
      Panel de Administraci√≥n
    </h1>
    <p class="subtitle">Gestiona pel√≠culas, calificaciones y base de datos</p>
  </header>

  <!-- Tabs -->
  <div class="tabs">
    <button
      class="tab-button"
      [class.active]="activeTab() === 'movies'"
      (click)="setActiveTab('movies')">
      <span class="material-icons">movie</span> Pel√≠culas
    </button>
    <button
      class="tab-button"
      [class.active]="activeTab() === 'ratings'"
      (click)="setActiveTab('ratings')">
      <span class="material-icons">star</span> Calificaciones
    </button>
    <button
      class="tab-button"
      [class.active]="activeTab() === 'requests'"
      (click)="setActiveTab('requests')">
      <span class="material-icons">inbox</span> Solicitudes
      @if (pendingRequestsCount() > 0) {
        <span class="badge">{{ pendingRequestsCount() }}</span>
      }
    </button>
    <button
      class="tab-button"
      [class.active]="activeTab() === 'remap'"
      (click)="setActiveTab('remap')">
      <span class="material-icons">storage</span> Remapeo BD
    </button>
    <button
      class="tab-button"
      [class.active]="activeTab() === 'similarities'"
      (click)="setActiveTab('similarities')">
      <span class="material-icons">hub</span> Similitudes
      @if (pendingSimilaritiesCount() > 0) {
        <span class="badge">{{ pendingSimilaritiesCount() }}</span>
      }
    </button>
  </div>

  <!-- MOVIES TAB -->
  @if (activeTab() === 'movies') {
    <div class="tab-content">
      <div class="section-header">
        <h2>Gesti√≥n de Pel√≠culas</h2>
        <button class="btn-primary" (click)="openAddMovieForm()">
          <span class="material-icons">add_circle</span>
          Agregar Pel√≠cula
        </button>
      </div>

      <!-- Filters -->
      <div class="filters-card">
        <div class="filter-grid">
          <div class="filter-group">
            <label>Buscar</label>
            <input
              type="text"
              [(ngModel)]="moviesFilters().search"
              (ngModelChange)="onMoviesFilterChange()"
              class="form-control"
              placeholder="Buscar por t√≠tulo...">
          </div>
          <div class="filter-group">
            <label>G√©nero</label>
            <select
              [(ngModel)]="moviesFilters().genre"
              (ngModelChange)="onMoviesFilterChange()"
              class="form-control">
              <option value="">Todos</option>
              @for (genre of availableGenres; track genre) {
                <option [value]="genre">{{ genre }}</option>
              }
            </select>
          </div>
          <div class="filter-group">
            <label>Ordenar por</label>
            <select
              [(ngModel)]="moviesFilters().sortBy"
              (ngModelChange)="onMoviesFilterChange()"
              class="form-control">
              <option value="title">T√≠tulo</option>
              <option value="year">A√±o</option>
              <option value="rating">Rating</option>
              <option value="popularity">Popularidad</option>
            </select>
          </div>
          <div class="filter-group">
            <label>Orden</label>
            <select
              [(ngModel)]="moviesFilters().sortOrder"
              (ngModelChange)="onMoviesFilterChange()"
              class="form-control">
              <option value="asc">Ascendente</option>
              <option value="desc">Descendente</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Movie Form -->
      @if (showMovieForm()) {
        <div class="form-modal-overlay" (click)="showMovieForm.set(false)">
          <div class="form-modal form-modal-large" (click)="$event.stopPropagation()">
            <h3>{{ isEditingMovie() ? 'Editar Pel√≠cula' : 'Agregar Nueva Pel√≠cula' }}</h3>

            <!-- Form Input Mode Tabs -->
            <div class="form-tabs">
              <button
                type="button"
                class="form-tab"
                [class.active]="formInputMode() === 'manual'"
                (click)="formInputMode.set('manual')">
                <span class="material-icons">edit</span>
                Entrada Manual
              </button>
              <button
                type="button"
                class="form-tab"
                [class.active]="formInputMode() === 'json'"
                (click)="formInputMode.set('json')">
                <span class="material-icons">code</span>
                Importar JSON
              </button>
            </div>

            <form (ngSubmit)="submitMovieForm()">
              <div class="form-scroll">

                <!-- MANUAL INPUT MODE -->
                @if (formInputMode() === 'manual') {
                  <!-- Basic Information -->
                  <div class="form-section">
                    <h4><span class="material-icons">info</span> Informaci√≥n B√°sica</h4>

                    <div class="form-row">
                      <div class="form-group">
                        <label>T√≠tulo *</label>
                        <input
                          type="text"
                          [(ngModel)]="movieForm().title"
                          name="title"
                          class="form-control"
                          placeholder="T√≠tulo de la pel√≠cula"
                          required>
                      </div>

                      <div class="form-group">
                        <label>A√±o *</label>
                        <input
                          type="number"
                          [(ngModel)]="movieForm().year"
                          name="year"
                          class="form-control"
                          min="1800"
                          [max]="2100"
                          required>
                      </div>
                    </div>

                    <div class="form-group">
                      <label>Sinopsis</label>
                      <textarea
                        [(ngModel)]="movieForm().overview"
                        name="overview"
                        class="form-control"
                        rows="4"
                        placeholder="Descripci√≥n de la pel√≠cula..."></textarea>
                    </div>

                    <div class="form-group">
                      <label>G√©neros * (Selecciona al menos uno)</label>
                      <div class="genre-dropdown">
                        <button
                          type="button"
                          class="genre-dropdown-toggle"
                          (click)="toggleGenreDropdown()">
                          <span>{{ getSelectedGenresText() }}</span>
                          <span class="material-icons">{{ genreDropdownOpen() ? 'expand_less' : 'expand_more' }}</span>
                        </button>
                        @if (genreDropdownOpen()) {
                          <div class="genre-dropdown-menu">
                            @for (genre of availableGenres; track genre) {
                              <label class="genre-dropdown-item">
                                <input
                                  type="checkbox"
                                  [checked]="movieForm().genres.includes(genre)"
                                  (change)="toggleMovieGenre(genre)">
                                <span>{{ genre }}</span>
                              </label>
                            }
                          </div>
                        }
                      </div>
                      @if (movieForm().genres.length > 0) {
                        <div class="selected-genres">
                          @for (genre of movieForm().genres; track genre) {
                            <span class="selected-genre-badge">
                              {{ genre }}
                              <button
                                type="button"
                                class="remove-genre"
                                (click)="toggleMovieGenre(genre)"
                                aria-label="Remover g√©nero">
                                <span class="material-icons">close</span>
                              </button>
                            </span>
                          }
                        </div>
                      }
                    </div>
                  </div>

                  <!-- Production Details -->
                  <div class="form-section">
                    <h4><span class="material-icons">movie_creation</span> Detalles de Producci√≥n</h4>

                    <div class="form-row">
                      <div class="form-group">
                        <label>Director</label>
                        <input
                          type="text"
                          [(ngModel)]="movieForm().director"
                          name="director"
                          class="form-control"
                          placeholder="Nombre del director">
                      </div>

                      <div class="form-group">
                        <label>Duraci√≥n (minutos)</label>
                        <input
                          type="number"
                          [(ngModel)]="movieForm().runtime"
                          name="runtime"
                          class="form-control"
                          min="1"
                          placeholder="120">
                      </div>
                    </div>

                    <div class="form-row">
                      <div class="form-group">
                        <label>Presupuesto ($)</label>
                        <input
                          type="number"
                          [(ngModel)]="movieForm().budget"
                          name="budget"
                          class="form-control"
                          min="0"
                          placeholder="30000000">
                      </div>

                      <div class="form-group">
                        <label>Recaudaci√≥n ($)</label>
                        <input
                          type="number"
                          [(ngModel)]="movieForm().revenue"
                          name="revenue"
                          class="form-control"
                          min="0"
                          placeholder="394436586">
                      </div>
                    </div>

                    <div class="form-group">
                      <label>Elenco (nombres separados por comas)</label>
                      <input
                        type="text"
                        [(ngModel)]="movieForm().castInput"
                        name="castInput"
                        class="form-control"
                        placeholder="Tom Hanks, Tim Allen, Don Rickles">
                      <small>Ej: Actor1, Actor2, Actor3...</small>
                    </div>

                    <div class="form-group">
                      <label>URLs de fotos del elenco (separadas por comas)</label>
                      <input
                        type="text"
                        [(ngModel)]="movieForm().castUrlsInput"
                        name="castUrlsInput"
                        class="form-control"
                        placeholder="https://image.tmdb.org/t/p/w185/actor1.jpg, https://...">
                      <small>URLs en el mismo orden que los nombres del elenco</small>
                    </div>
                  </div>

                  <!-- Links -->
                  <div class="form-section">
                    <h4><span class="material-icons">link</span> Enlaces Externos</h4>

                    <div class="form-group">
                      <label>MovieLens URL</label>
                      <input
                        type="text"
                        [(ngModel)]="movieForm().movieLensLink"
                        name="movieLensLink"
                        class="form-control"
                        placeholder="https://movielens.org/movies/1">
                    </div>

                    <div class="form-group">
                      <label>IMDB URL</label>
                      <input
                        type="text"
                        [(ngModel)]="movieForm().imdbLink"
                        name="imdbLink"
                        class="form-control"
                        placeholder="http://www.imdb.com/title/tt0114709/">
                    </div>

                    <div class="form-group">
                      <label>TMDB URL</label>
                      <input
                        type="text"
                        [(ngModel)]="movieForm().tmdbLink"
                        name="tmdbLink"
                        class="form-control"
                        placeholder="https://www.themoviedb.org/movie/862">
                    </div>

                    <div class="form-group">
                      <label>URL del Poster</label>
                      <input
                        type="text"
                        [(ngModel)]="movieForm().posterUrl"
                        name="posterUrl"
                        class="form-control"
                        placeholder="https://image.tmdb.org/t/p/w500/...">
                    </div>
                  </div>

                  <!-- Tags -->
                  <div class="form-section">
                    <h4><span class="material-icons">label</span> Etiquetas</h4>

                    <div class="form-group">
                      <label>Genome Tags (separados por comas)</label>
                      <input
                        type="text"
                        [(ngModel)]="movieForm().genomeTagsInput"
                        name="genomeTagsInput"
                        class="form-control"
                        placeholder="toys, computer animation, pixar animation">
                      <small>Las etiquetas m√°s relevantes para clasificar la pel√≠cula</small>
                    </div>

                    <div class="form-group">
                      <label>User Tags (separados por comas)</label>
                      <input
                        type="text"
                        [(ngModel)]="movieForm().userTagsInput"
                        name="userTagsInput"
                        class="form-control"
                        placeholder="pixar, animation, disney, funny">
                      <small>Etiquetas definidas por usuarios</small>
                    </div>
                  </div>
                }

                <!-- JSON INPUT MODE -->
                @if (formInputMode() === 'json') {
                  <div class="form-section">
                    <h4><span class="material-icons">code</span> Importar JSON Completo</h4>

                    <div class="form-group">
                      <label>Pega el JSON de la pel√≠cula</label>
                      <textarea
                        [(ngModel)]="movieForm().jsonData"
                        name="jsonData"
                        class="form-control json-input"
                        rows="20"
                        placeholder='{"movieId":1,"title":"Toy Story","year":1995,"genres":["Adventure","Animation"],...}'
                        spellcheck="false"></textarea>
                      <small>
                        <strong>Nota:</strong> El JSON debe seguir la estructura del modelo de pel√≠cula.
                        Incluye campos como: movieId, title, year, genres, links, genomeTags, userTags, ratingStats, externalData, etc.
                      </small>
                    </div>

                    <div class="json-help">
                      <details>
                        <summary>üìñ Ver ejemplo de estructura JSON</summary>
                        <pre><code>{{ '{' }}
  "movieId": 1,
  "title": "Toy Story",
  "year": 1995,
  "genres": ["Adventure", "Animation", "Children"],
  "links": {{ '{' }}
    "movielens": "https://movielens.org/movies/1",
    "imdb": "http://www.imdb.com/title/tt0114709/",
    "tmdb": "https://www.themoviedb.org/movie/862"
  {{ '}' }},
  "genomeTags": [
    {{ '{' }}"tag": "toys", "relevance": 0.99925{{ '}' }},
    {{ '{' }}"tag": "computer animation", "relevance": 0.99875{{ '}' }}
  ],
  "userTags": ["pixar", "animation", "disney"],
  "ratingStats": {{ '{' }}
    "average": 3.89,
    "count": 57309
  {{ '}' }},
  "externalData": {{ '{' }}
    "posterUrl": "https://image.tmdb.org/t/p/w500/...",
    "overview": "Led by Woody, Andy's toys live happily...",
    "cast": [
      {{ '{' }}"name": "Tom Hanks", "profileUrl": "https://..."{{ '}' }}
    ],
    "director": "John Lasseter",
    "runtime": 81,
    "budget": 30000000,
    "revenue": 394436586
  {{ '}' }}
{{ '}' }}</code></pre>
                      </details>
                    </div>
                  </div>
                }

              </div>

              <div class="form-actions">
                <button type="button" class="btn-secondary" (click)="showMovieForm.set(false)">
                  Cancelar
                </button>
                <button type="submit" class="btn-primary" [disabled]="isSubmitting()">
                  {{ isSubmitting() ? 'Guardando...' : 'Guardar' }}
                </button>
              </div>
            </form>
          </div>
        </div>
      }

      <!-- Movies Table -->
      @if (isLoadingMovies()) {
        <div class="loading">Cargando pel√≠culas...</div>
      } @else {
        <div class="table-responsive">
          <table class="data-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>T√≠tulo</th>
                <th>A√±o</th>
                <th>G√©neros</th>
                <th>Rating</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              @for (movie of movies(); track movie.movieId) {
                <tr>
                  <td>{{ movie.movieId }}</td>
                  <td>
                    <div class="movie-cell">
                      @if (movie.externalData?.posterUrl) {
                        <img [src]="movie.externalData!.posterUrl" [alt]="movie.title" class="mini-poster">
                      }
                      <span>{{ movie.title }}</span>
                    </div>
                  </td>
                  <td>{{ movie.year || 'N/A' }}</td>
                  <td>
                    <div class="genres-cell">
                      @for (genre of movie.genres.slice(0, 2); track genre) {
                        <span class="genre-tag">{{ genre }}</span>
                      }
                    </div>
                  </td>
                  <td>{{ movie.ratingStats?.average?.toFixed(1) || 'N/A' }}</td>
                  <td>
                    <div class="actions-cell">
                      <button class="btn-small btn-edit" (click)="openEditMovieForm(movie)">
                        <span class="material-icons">edit</span>
                      </button>
                      <button class="btn-small btn-delete" (click)="deleteMovie(movie.movieId, movie.title)">
                        <span class="material-icons">delete</span>
                      </button>
                    </div>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        <div class="pagination">
          <button
            class="btn-pagination"
            (click)="previousMoviesPage()"
            [disabled]="moviesPage() === 0">
            ‚Üê Anterior
          </button>
          <span class="pagination-info">
            P√°gina {{ moviesPage() + 1 }} de {{ moviesTotalPages() }} ({{ moviesTotal() }} total)
          </span>
          <button
            class="btn-pagination"
            (click)="nextMoviesPage()"
            [disabled]="moviesPage() >= moviesTotalPages() - 1">
            Siguiente ‚Üí
          </button>
        </div>
      }
    </div>
  }

  <!-- RATINGS TAB -->
  @if (activeTab() === 'ratings') {
    <div class="tab-content">
      <div class="section-header">
        <h2>Gesti√≥n de Calificaciones</h2>
        <button class="btn-primary" (click)="openAddRatingForm()">
          ‚ûï Agregar Calificaci√≥n
        </button>
      </div>

      <!-- Filters -->
      <div class="filters-card">
        <div class="filter-grid">
          <div class="filter-group">
            <label>Usuario</label>
            <select
              [(ngModel)]="ratingsFilters().userId"
              (ngModelChange)="onRatingsFilterChange()"
              class="form-control">
              <option [value]="undefined">Todos</option>
              @for (user of availableUsers; track user.userId) {
                <option [value]="user.userId">{{ user.firstName }} {{ user.lastName }}</option>
              }
            </select>
          </div>
          <div class="filter-group">
            <label>Pel√≠cula</label>
            <select
              [(ngModel)]="ratingsFilters().movieId"
              (ngModelChange)="onRatingsFilterChange()"
              class="form-control">
              <option [value]="undefined">Todas</option>
              @for (movie of availableMovies().slice(0, 50); track movie.movieId) {
                <option [value]="movie.movieId">{{ movie.title }}</option>
              }
            </select>
          </div>
          <div class="filter-group">
            <label>Rating m√≠nimo</label>
            <select
              [(ngModel)]="ratingsFilters().minRating"
              (ngModelChange)="onRatingsFilterChange()"
              class="form-control">
              <option [value]="0">Todos</option>
              <option [value]="1">‚òÖ 1+</option>
              <option [value]="2">‚òÖ 2+</option>
              <option [value]="3">‚òÖ 3+</option>
              <option [value]="4">‚òÖ 4+</option>
              <option [value]="5">‚òÖ 5</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Rating Form -->
      @if (showRatingForm()) {
        <div class="form-modal-overlay" (click)="showRatingForm.set(false)">
          <div class="form-modal small" (click)="$event.stopPropagation()">
            <h3>{{ isEditingRating() ? 'Editar Calificaci√≥n' : 'Agregar Calificaci√≥n' }}</h3>

            <form (ngSubmit)="submitRatingForm()">
              <div class="form-group">
                <label>Usuario *</label>
                <select
                  [(ngModel)]="ratingForm().userId"
                  name="userId"
                  class="form-control"
                  [disabled]="isEditingRating()"
                  required>
                  @for (user of availableUsers; track user.userId) {
                    <option [value]="user.userId">{{ user.firstName }} {{ user.lastName }}</option>
                  }
                </select>
              </div>

              <div class="form-group">
                <label>Pel√≠cula *</label>
                <select
                  [(ngModel)]="ratingForm().movieId"
                  name="movieId"
                  class="form-control"
                  [disabled]="isEditingRating()"
                  required>
                  @for (movie of availableMovies(); track movie.movieId) {
                    <option [value]="movie.movieId">{{ movie.title }}</option>
                  }
                </select>
              </div>

              <div class="form-group">
                <label>Calificaci√≥n * (0.5 - 5.0)</label>
                <input
                  type="number"
                  [(ngModel)]="ratingForm().rating"
                  name="rating"
                  class="form-control"
                  min="0.5"
                  max="5"
                  step="0.5"
                  required>
                <div class="rating-preview">
                  <app-star-rating [rating]="ratingForm().rating"></app-star-rating>
                </div>
              </div>

              <div class="form-actions">
                <button type="button" class="btn-secondary" (click)="showRatingForm.set(false)">
                  Cancelar
                </button>
                <button type="submit" class="btn-primary" [disabled]="isSubmitting()">
                  {{ isSubmitting() ? 'Guardando...' : 'Guardar' }}
                </button>
              </div>
            </form>
          </div>
        </div>
      }

      <!-- Ratings Table -->
      @if (isLoadingRatings()) {
        <div class="loading">Cargando calificaciones...</div>
      } @else {
        <div class="table-responsive">
          <table class="data-table">
            <thead>
              <tr>
                <th>Usuario</th>
                <th>Pel√≠cula</th>
                <th>Calificaci√≥n</th>
                <th>Fecha</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              @for (rating of ratings(); track rating.userId + '-' + rating.movieId) {
                <tr>
                  <td>{{ rating.userName || getUserName(rating.userId) }}</td>
                  <td>{{ rating.movieTitle || getMovieTitle(rating.movieId) }}</td>
                  <td>
                    <app-star-rating [rating]="rating.rating"></app-star-rating>
                  </td>
                  <td>{{ formatDate(rating.timestamp) }}</td>
                  <td>
                    <div class="actions-cell">
                      <button class="btn-small btn-edit" (click)="openEditRatingForm(rating)">
                        <span class="material-icons">edit</span>
                      </button>
                      <button
                        class="btn-small btn-delete"
                        (click)="deleteRating(rating.userId, rating.movieId, rating.userName || getUserName(rating.userId), rating.movieTitle || getMovieTitle(rating.movieId))">
                        <span class="material-icons">delete</span>
                      </button>
                    </div>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        <div class="pagination">
          <button
            class="btn-pagination"
            (click)="previousRatingsPage()"
            [disabled]="ratingsPage() === 0">
            ‚Üê Anterior
          </button>
          <span class="pagination-info">
            P√°gina {{ ratingsPage() + 1 }} de {{ ratingsTotalPages() }} ({{ ratingsTotal() }} total)
          </span>
          <button
            class="btn-pagination"
            (click)="nextRatingsPage()"
            [disabled]="ratingsPage() >= ratingsTotalPages() - 1">
            Siguiente ‚Üí
          </button>
        </div>
      }
    </div>
  }

  <!-- REQUESTS TAB -->
  @if (activeTab() === 'requests') {
    <div class="tab-content">
      <h2><span class="material-icons">assignment</span> Gesti√≥n de Solicitudes</h2>

      <!-- Filters -->
      <div class="requests-filters">
        <button
          [class.active]="requestsFilter() === 'pending'"
          (click)="setRequestsFilter('pending')">
          <span class="material-icons">schedule</span> Pendientes
          @if (pendingRequestsCount() > 0) {
            <span class="badge">{{ pendingRequestsCount() }}</span>
          }
        </button>
        <button
          [class.active]="requestsFilter() === 'approved'"
          (click)="setRequestsFilter('approved')">
          <span class="material-icons">check_circle</span> Aprobadas
        </button>
        <button
          [class.active]="requestsFilter() === 'rejected'"
          (click)="setRequestsFilter('rejected')">
          <span class="material-icons">cancel</span> Rechazadas
        </button>
        <button
          [class.active]="requestsFilter() === 'all'"
          (click)="setRequestsFilter('all')">
          <span class="material-icons">list</span> Todas
        </button>
      </div>

      <!-- Requests Table -->
      @if (filteredRequests().length > 0) {
        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Usuario</th>
                <th>Tipo</th>
                <th>Pel√≠cula</th>
                <th>Estado</th>
                <th>Fecha</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              @for (request of filteredRequests(); track request.requestId) {
                <tr>
                  <td>{{ request.requestId }}</td>
                  <td>
                    <div class="user-info">
                      <strong>ID: {{ request.userId }}</strong>
                    </div>
                  </td>
                  <td>
                    <span [class]="'request-type ' + request.requestType">
                      <span class="material-icons">{{ request.requestType === 'add' ? 'add' : 'edit' }}</span>
                      {{ request.requestType === 'add' ? 'Agregar' : 'Editar' }}
                    </span>
                  </td>
                  <td>
                    <div class="movie-info">
                      <strong>{{ request.movieData.title }}</strong>
                      @if (request.movieData.year) {
                        <span class="year">({{ request.movieData.year }})</span>
                      }
                      @if (request.movieData.genres && request.movieData.genres.length > 0) {
                        <div class="genres-mini">
                          {{ request.movieData.genres.slice(0, 2).join(', ') }}
                          @if (request.movieData.genres.length > 2) {
                            <span>+{{ request.movieData.genres.length - 2 }}</span>
                          }
                        </div>
                      }
                    </div>
                  </td>
                  <td>
                    <span [class]="'status-badge ' + request.status">
                      @if (request.status === 'pending') { <span class="material-icons">schedule</span> Pendiente }
                      @if (request.status === 'approved') { <span class="material-icons">check_circle</span> Aprobada }
                      @if (request.status === 'rejected') { <span class="material-icons">cancel</span> Rechazada }
                    </span>
                  </td>
                  <td>
                    <div class="date-info">
                      <div>{{ request.createdAt | date:'short' }}</div>
                      @if (request.updatedAt && request.updatedAt !== request.createdAt) {
                        <small>Actualizada: {{ request.updatedAt | date:'short' }}</small>
                      }
                    </div>
                  </td>
                  <td>
                    <div class="action-buttons">
                      <button
                        class="btn-view"
                        (click)="viewRequestDetails(request)"
                        title="Ver detalles">
                        <span class="material-icons">visibility</span> Ver
                      </button>
                      @if (request.status === 'pending') {
                        <button
                          class="btn-approve"
                          (click)="approveRequest(request)"
                          title="Aprobar solicitud">
                          <span class="material-icons">check</span>
                        </button>
                        <button
                          class="btn-reject"
                          (click)="rejectRequest(request)"
                          title="Rechazar solicitud">
                          <span class="material-icons">close</span>
                        </button>
                      }
                    </div>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      } @else {
        <div class="empty-state">
          <span class="material-icons">inbox</span>
          <p>No hay solicitudes {{ requestsFilter() === 'all' ? '' : requestsFilter() === 'pending' ? 'pendientes' : requestsFilter() === 'approved' ? 'aprobadas' : 'rechazadas' }}</p>
        </div>
      }
    </div>
  }

  <!-- Request Details Modal -->
  @if (showRequestDetails() && selectedRequest()) {
    <div class="modal-overlay" (click)="closeRequestDetails()">
      <div class="modal-content request-details" (click)="$event.stopPropagation()">
        <button class="modal-close" (click)="closeRequestDetails()">‚úï</button>

        <h2>Detalles de la Solicitud</h2>

        <div class="request-detail-section">
          <h3><span class="material-icons">assignment</span> Informaci√≥n General</h3>
          <div class="detail-grid">
            <div class="detail-item">
              <strong>ID:</strong>
              <span>{{ selectedRequest()!.requestId }}</span>
            </div>
            <div class="detail-item">
              <strong>Usuario ID:</strong>
              <span>{{ selectedRequest()!.userId }}</span>
            </div>
            <div class="detail-item">
              <strong>Tipo:</strong>
              <span>{{ selectedRequest()!.requestType === 'add' ? 'Agregar pel√≠cula' : 'Editar pel√≠cula' }}</span>
            </div>
            <div class="detail-item">
              <strong>Estado:</strong>
              <span [class]="'status-badge ' + selectedRequest()!.status">
                {{ selectedRequest()!.status === 'pending' ? 'Pendiente' : selectedRequest()!.status === 'approved' ? 'Aprobada' : 'Rechazada' }}
              </span>
            </div>
            <div class="detail-item">
              <strong>Creada:</strong>
              <span>{{ selectedRequest()!.createdAt | date:'medium' }}</span>
            </div>
            @if (selectedRequest()!.updatedAt && selectedRequest()!.updatedAt !== selectedRequest()!.createdAt) {
              <div class="detail-item">
                <strong>Actualizada:</strong>
                <span>{{ selectedRequest()!.updatedAt | date:'medium' }}</span>
              </div>
            }
            @if (selectedRequest()!.reviewedBy) {
              <div class="detail-item">
                <strong>Revisada por:</strong>
                <span>Admin ID {{ selectedRequest()!.reviewedBy }}</span>
              </div>
            }
          </div>
        </div>

        <div class="request-detail-section">
          <h3><span class="material-icons">movie</span> Datos de la Pel√≠cula</h3>
          <div class="movie-detail-grid">
            <div class="detail-item full-width">
              <strong>T√≠tulo:</strong>
              <span>{{ selectedRequest()!.movieData.title }}</span>
            </div>
            @if (selectedRequest()!.movieData.year) {
              <div class="detail-item">
                <strong>A√±o:</strong>
                <span>{{ selectedRequest()!.movieData.year }}</span>
              </div>
            }
            @if (selectedRequest()!.movieData.genres && selectedRequest()!.movieData.genres!.length > 0) {
              <div class="detail-item full-width">
                <strong>G√©neros:</strong>
                <span>{{ selectedRequest()!.movieData.genres!.join(', ') }}</span>
              </div>
            }
            @if (selectedRequest()!.movieData.links.tmdb) {
              <div class="detail-item">
                <strong>TMDB ID:</strong>
                <span>{{ selectedRequest()!.movieData.links.tmdb }}</span>
              </div>
            }
            @if (selectedRequest()!.movieData.links.imdb) {
              <div class="detail-item">
                <strong>IMDB ID:</strong>
                <span>{{ selectedRequest()!.movieData.links.imdb }}</span>
              </div>
            }
          </div>
        </div>

        @if (selectedRequest()!.reviewNote) {
          <div class="request-detail-section">
            <h3>üí¨ Nota de Revisi√≥n</h3>
            <p class="review-note">{{ selectedRequest()!.reviewNote }}</p>
          </div>
        }

        @if (selectedRequest()!.status === 'pending') {
          <div class="request-detail-section">
            <h3><span class="material-icons">edit_note</span> Nota de Revisi√≥n (Opcional)</h3>
            <textarea
              [(ngModel)]="reviewNote"
              placeholder="Agregar nota de revisi√≥n..."
              rows="3"
              class="review-note-input"></textarea>
          </div>

          <div class="modal-actions">
            <button class="btn-approve-large" (click)="approveRequest(selectedRequest()!)">
              <span class="material-icons">check_circle</span> Aprobar Solicitud
            </button>
            <button class="btn-reject-large" (click)="rejectRequest(selectedRequest()!)">
              <span class="material-icons">cancel</span> Rechazar Solicitud
            </button>
          </div>
        }
      </div>
    </div>
  }

  <!-- REMAP TAB -->
  @if (activeTab() === 'remap') {
    <div class="tab-content">
      <div class="remap-container">
        <h2><span class="material-icons">storage</span> Remapeo de Base de Datos</h2>

        <div class="remap-info">
          <h3>¬øQu√© hace el remapeo?</h3>
          <ul>
            <li>Reorganiza y optimiza los √≠ndices de la base de datos</li>
            <li>Recalcula las similitudes entre pel√≠culas</li>
            <li>Actualiza las estad√≠sticas de calificaciones</li>
            <li>Limpia datos inconsistentes o hu√©rfanos</li>
          </ul>

          <div class="warning-box">
            <strong><span class="material-icons">warning</span> Advertencia:</strong>
            <p>Este proceso puede tardar varios minutos dependiendo del tama√±o de la base de datos. Durante el remapeo, el sistema puede experimentar lentitud.</p>
          </div>
        </div>

        @if (!remapResult()) {
          <div class="remap-action">
            <button
              class="btn-danger"
              (click)="confirmRemap()"
              [disabled]="isRemapping()">
              @if (isRemapping()) {
                <span class="material-icons">hourglass_empty</span> Remapeando...
              } @else {
                <span class="material-icons">refresh</span> Iniciar Remapeo
              }
            </button>
          </div>
        }

        @if (isRemapping()) {
          <div class="remap-progress">
            <div class="spinner"></div>
            <p>Remapeando base de datos... Por favor espera.</p>
          </div>
        }

        @if (remapResult()) {
          <div class="remap-result" [class.success]="remapResult()!.success" [class.error]="!remapResult()!.success">
            <h3>
              <span class="material-icons">{{ remapResult()!.success ? 'check_circle' : 'error' }}</span>
              {{ remapResult()!.success ? 'Remapeo Exitoso' : 'Error en Remapeo' }}
            </h3>
            <p>{{ remapResult()!.message }}</p>

            @if (remapResult()!.affectedMovies !== undefined) {
              <div class="result-stats">
                <div class="stat">
                  <span class="label">Pel√≠culas afectadas:</span>
                  <span class="value">{{ remapResult()!.affectedMovies }}</span>
                </div>
                <div class="stat">
                  <span class="label">Calificaciones afectadas:</span>
                  <span class="value">{{ remapResult()!.affectedRatings }}</span>
                </div>
                <div class="stat">
                  <span class="label">Duraci√≥n:</span>
                  <span class="value">{{ remapResult()!.duration! / 1000 }} segundos</span>
                </div>
              </div>
            }

            <button class="btn-primary" (click)="remapResult.set(null)">
              Realizar Otro Remapeo
            </button>
          </div>
        }
      </div>
    </div>
  }

  <!-- SIMILARITIES TAB -->
  @if (activeTab() === 'similarities') {
    <div class="tab-content">
      <div class="similarities-container">
        <h2><span class="material-icons">hub</span> Gesti√≥n de Similitudes</h2>

        <!-- Estado de Similitudes -->
        <div class="similarities-status-card">
          <h3><span class="material-icons">analytics</span> Estado de Similitudes</h3>

          @if (isLoadingSimilarities()) {
            <div class="loading-section">
              <div class="spinner"></div>
              <p>Cargando estado...</p>
            </div>
          } @else {
            <div class="status-grid">
              <div class="status-item">
                <div class="status-icon total">
                  <span class="material-icons">movie_filter</span>
                </div>
                <div class="status-content">
                  <span class="status-value">{{ similaritiesStatus().totalMovies }}</span>
                  <span class="status-label">Pel√≠culas Totales</span>
                </div>
              </div>

              <div class="status-item">
                <div class="status-icon success">
                  <span class="material-icons">check_circle</span>
                </div>
                <div class="status-content">
                  <span class="status-value">{{ similaritiesStatus().moviesWithSimilarities }}</span>
                  <span class="status-label">Con Similitudes</span>
                </div>
              </div>

              <div class="status-item">
                <div class="status-icon warning">
                  <span class="material-icons">pending</span>
                </div>
                <div class="status-content">
                  <span class="status-value">{{ similaritiesStatus().moviesPending }}</span>
                  <span class="status-label">Pendientes</span>
                </div>
              </div>

              <div class="status-item">
                <div class="status-icon info">
                  <span class="material-icons">schedule</span>
                </div>
                <div class="status-content">
                  <span class="status-value">
                    @if (similaritiesStatus().lastCalculated) {
                      {{ similaritiesStatus().lastCalculated | date:'short' }}
                    } @else {
                      Nunca
                    }
                  </span>
                  <span class="status-label">√öltimo C√°lculo</span>
                </div>
              </div>
            </div>

            <!-- Progress Bar -->
            <div class="progress-section">
              <div class="progress-header">
                <span>Cobertura de Similitudes</span>
                <span class="progress-percentage">
                  {{ ((similaritiesStatus().moviesWithSimilarities / similaritiesStatus().totalMovies) * 100).toFixed(1) }}%
                </span>
              </div>
              <div class="progress-bar">
                <div
                  class="progress-fill"
                  [style.width.%]="(similaritiesStatus().moviesWithSimilarities / similaritiesStatus().totalMovies) * 100">
                </div>
              </div>
            </div>
          }
        </div>

        <!-- Pel√≠culas Pendientes -->
        @if (similaritiesStatus().moviesPending > 0) {
          <div class="pending-movies-card">
            <div class="card-header">
              <h3><span class="material-icons">list</span> Pel√≠culas Pendientes ({{ pendingMovies().length }})</h3>
              <button
                class="btn-primary"
                (click)="confirmCalculateSimilarities()"
                [disabled]="isCalculatingSimilarities()">
                @if (isCalculatingSimilarities()) {
                  <span class="material-icons">hourglass_empty</span> Calculando...
                } @else {
                  <span class="material-icons">calculate</span> Calcular Similitudes
                }
              </button>
            </div>

            @if (isCalculatingSimilarities()) {
              <div class="calculation-progress">
                <div class="spinner"></div>
                <p>Calculando similitudes... Este proceso puede tardar algunos minutos.</p>
              </div>
            }

            @if (!isCalculatingSimilarities() && pendingMovies().length > 0) {
              <div class="pending-movies-table">
                <table>
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>T√≠tulo</th>
                      <th>A√±o</th>
                      <th>G√©neros</th>
                      <th>Estado</th>
                    </tr>
                  </thead>
                  <tbody>
                    @for (movie of pendingMovies().slice(0, 10); track movie.movieId) {
                      <tr>
                        <td>{{ movie.movieId }}</td>
                        <td class="movie-title-cell">{{ movie.title }}</td>
                        <td>{{ movie.year || 'N/A' }}</td>
                        <td>
                          <div class="genres-cell">
                            @for (genre of movie.genres.slice(0, 2); track genre) {
                              <span class="genre-tag">{{ genre }}</span>
                            }
                            @if (movie.genres.length > 2) {
                              <span class="genre-more">+{{ movie.genres.length - 2 }}</span>
                            }
                          </div>
                        </td>
                        <td>
                          <span class="status-badge pending">
                            <span class="material-icons">pending</span>
                            Pendiente
                          </span>
                        </td>
                      </tr>
                    }
                  </tbody>
                </table>

                @if (pendingMovies().length > 10) {
                  <div class="table-footer">
                    <p>Mostrando 10 de {{ pendingMovies().length }} pel√≠culas pendientes</p>
                  </div>
                }
              </div>
            }
          </div>
        }

        <!-- Resultado del C√°lculo -->
        @if (similaritiesResult()) {
          <div class="calculation-result" [class.success]="similaritiesResult()!.success" [class.error]="!similaritiesResult()!.success">
            <h3>
              <span class="material-icons">{{ similaritiesResult()!.success ? 'check_circle' : 'error' }}</span>
              {{ similaritiesResult()!.success ? 'C√°lculo Exitoso' : 'Error en C√°lculo' }}
            </h3>
            <p>{{ similaritiesResult()!.message }}</p>

            @if (similaritiesResult()!.processedMovies !== undefined) {
              <div class="result-stats">
                <div class="stat">
                  <span class="label">Pel√≠culas procesadas:</span>
                  <span class="value">{{ similaritiesResult()!.processedMovies }}</span>
                </div>
                <div class="stat">
                  <span class="label">Duraci√≥n:</span>
                  <span class="value">{{ similaritiesResult()!.duration! / 1000 }} segundos</span>
                </div>
              </div>
            }

            <button class="btn-primary" (click)="similaritiesResult.set(null)">
              Cerrar
            </button>
          </div>
        }

        <!-- Sin Pendientes -->
        @if (similaritiesStatus().moviesPending === 0 && !isLoadingSimilarities()) {
          <div class="no-pending-card">
            <span class="material-icons">check_circle_outline</span>
            <h3>¬°Todas las similitudes est√°n actualizadas!</h3>
            <p>No hay pel√≠culas pendientes de mapeo. El sistema est√° al d√≠a.</p>
          </div>
        }
      </div>
    </div>
  }
</div>
