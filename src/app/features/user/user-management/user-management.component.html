<div class="user-management-container">
  <header class="header">
    <h1>
      <span class="material-icons">dashboard</span>
      Mis Gestiones
    </h1>
    <p class="subtitle">Administra tus solicitudes y calificaciones</p>
  </header>

  <!-- Tabs -->
  <div class="tabs">
    <button
      class="tab-button"
      [class.active]="activeTab() === 'requests'"
      (click)="setActiveTab('requests')">
      <span class="material-icons">request_page</span>
      Solicitudes de Películas
    </button>
    <button
      class="tab-button"
      [class.active]="activeTab() === 'ratings'"
      (click)="setActiveTab('ratings')">
      <span class="material-icons">star</span> Mis Calificaciones
    </button>
  </div>

  <!-- REQUESTS TAB -->
  @if (activeTab() === 'requests') {
    <div class="tab-content">
      <div class="section-header">
        <h2>Solicitudes de Películas</h2>
        <button class="btn-toggle-form" (click)="toggleRequestForm()">
          <span class="material-icons">{{ showRequestForm() ? 'close' : 'add' }}</span>
          {{ showRequestForm() ? 'Cancelar' : 'Nueva Solicitud' }}
        </button>
      </div>

      <!-- Request Form -->
      @if (showRequestForm()) {
        <div class="request-form-card">
          <h3>{{ requestForm().requestType === 'add' ? 'Agregar Nueva Película' : 'Editar Película' }}</h3>

          <!-- Form Input Mode Tabs -->
          <div class="form-tabs">
            <button
              type="button"
              class="form-tab"
              [class.active]="formInputMode() === 'manual'"
              (click)="formInputMode.set('manual')">
              <span class="material-icons">edit</span>
              Entrada Manual
            </button>
            <button
              type="button"
              class="form-tab"
              [class.active]="formInputMode() === 'url'"
              (click)="formInputMode.set('url')">
              <span class="material-icons">link</span>
              Importar desde URL
            </button>
          </div>

          <form (ngSubmit)="submitMovieRequest()">
            <div class="form-scroll">

              <!-- MANUAL INPUT MODE -->
              @if (formInputMode() === 'manual') {
                <!-- Type Selection -->
                <div class="form-section">
                  <h4><span class="material-icons">settings</span> Tipo de Solicitud</h4>

                  <div class="form-row">
                    <div class="form-group">
                      <label>Tipo de Solicitud *</label>
                      <select [(ngModel)]="requestForm().requestType" name="requestType" class="form-control">
                        <option value="add">Agregar nueva película</option>
                        <option value="edit">Editar película existente</option>
                      </select>
                    </div>

                    @if (requestForm().requestType === 'edit') {
                      <div class="form-group">
                        <label>ID de Película *</label>
                        <input
                          type="number"
                          [(ngModel)]="requestForm().movieId"
                          name="movieId"
                          class="form-control"
                          placeholder="ID de la película a editar"
                          required>
                      </div>
                    }
                  </div>
                </div>

                <!-- Basic Information -->
                <div class="form-section">
                  <h4><span class="material-icons">info</span> Información Básica</h4>

                  <div class="form-row">
                    <div class="form-group">
                      <label>Título *</label>
                      <input
                        type="text"
                        [(ngModel)]="requestForm().title"
                        name="title"
                        class="form-control"
                        placeholder="Título de la película"
                        required>
                    </div>

                    <div class="form-group">
                      <label>Año *</label>
                      <input
                        type="number"
                        [(ngModel)]="requestForm().year"
                        name="year"
                        class="form-control"
                        min="1800"
                        [max]="2100"
                        required>
                    </div>
                  </div>

                  <div class="form-group">
                    <label>Géneros * (Selecciona al menos uno)</label>
                    <div class="genre-dropdown">
                      <button
                        type="button"
                        class="genre-dropdown-toggle"
                        (click)="toggleGenreDropdown()">
                        <span>{{ getSelectedGenresText() }}</span>
                        <span class="material-icons">{{ genreDropdownOpen() ? 'expand_less' : 'expand_more' }}</span>
                      </button>
                      @if (genreDropdownOpen()) {
                        <div class="genre-dropdown-menu">
                          @for (genre of availableGenres; track genre) {
                            <label class="genre-dropdown-item">
                              <input
                                type="checkbox"
                                [checked]="requestForm().genres.includes(genre)"
                                (change)="toggleGenre(genre)">
                              <span>{{ genre }}</span>
                            </label>
                          }
                        </div>
                      }
                    </div>
                    @if (requestForm().genres.length > 0) {
                      <div class="selected-genres">
                        @for (genre of requestForm().genres; track genre) {
                          <span class="selected-genre-badge">
                            {{ genre }}
                            <button
                              type="button"
                              class="remove-genre"
                              (click)="toggleGenre(genre)"
                              aria-label="Remover género">
                              <span class="material-icons">close</span>
                            </button>
                          </span>
                        }
                      </div>
                    }
                  </div>
                </div>

                <!-- External Links -->
                <div class="form-section">
                  <h4><span class="material-icons">link</span> Enlaces Externos</h4>

                  <div class="form-group">
                    <label>MovieLens Link</label>
                    <input
                      type="text"
                      [(ngModel)]="requestForm().movieLensLink"
                      name="movieLensLink"
                      class="form-control"
                      placeholder="https://movielens.org/movies/...">
                  </div>

                  <div class="form-group">
                    <label>IMDB Link</label>
                    <input
                      type="text"
                      [(ngModel)]="requestForm().imdbLink"
                      name="imdbLink"
                      class="form-control"
                      placeholder="https://www.imdb.com/title/tt...">
                  </div>

                  <div class="form-group">
                    <label>TMDB Link</label>
                    <input
                      type="text"
                      [(ngModel)]="requestForm().tmdbLink"
                      name="tmdbLink"
                      class="form-control"
                      placeholder="https://www.themoviedb.org/movie/...">
                  </div>
                </div>

                <!-- Additional Information -->
                <div class="form-section">
                  <h4><span class="material-icons">description</span> Información Adicional</h4>

                  <div class="form-group">
                    <label>Sinopsis</label>
                    <textarea
                      [(ngModel)]="requestForm().overview"
                      name="overview"
                      class="form-control"
                      rows="4"
                      placeholder="Descripción de la película..."></textarea>
                  </div>

                  <div class="form-group">
                    <label>Director</label>
                    <input
                      type="text"
                      [(ngModel)]="requestForm().director"
                      name="director"
                      class="form-control"
                      placeholder="Nombre del director">
                  </div>

                  <div class="form-row">
                    <div class="form-group">
                      <label>Presupuesto (USD)</label>
                      <input
                        type="number"
                        [(ngModel)]="requestForm().budget"
                        name="budget"
                        class="form-control"
                        min="0"
                        placeholder="Ej: 150000000">
                    </div>

                    <div class="form-group">
                      <label>Recaudación (USD)</label>
                      <input
                        type="number"
                        [(ngModel)]="requestForm().revenue"
                        name="revenue"
                        class="form-control"
                        min="0"
                        placeholder="Ej: 500000000">
                    </div>
                  </div>

                  <div class="form-group">
                    <label>Elenco (separados por comas)</label>
                    <input
                      type="text"
                      [(ngModel)]="requestForm().cast"
                      name="cast"
                      class="form-control"
                      placeholder="Actor 1, Actor 2, Actor 3">
                  </div>

                  <div class="form-group">
                    <label>URL del Elenco</label>
                    <input
                      type="url"
                      [(ngModel)]="requestForm().castUrl"
                      name="castUrl"
                      class="form-control"
                      placeholder="https://...">
                  </div>

                  <div class="form-group">
                    <label>URL del Póster</label>
                    <input
                      type="url"
                      [(ngModel)]="requestForm().posterUrl"
                      name="posterUrl"
                      class="form-control"
                      placeholder="https://image.tmdb.org/t/p/w500/...">
                  </div>
                </div>

                <!-- Tags -->
                <div class="form-section">
                  <h4><span class="material-icons">label</span> Tags</h4>

                  <div class="form-group">
                    <label>Genome Tags (separados por comas)</label>
                    <input
                      type="text"
                      [(ngModel)]="requestForm().genomeTags"
                      name="genomeTags"
                      class="form-control"
                      placeholder="action, thriller, suspense">
                  </div>

                  <div class="form-group">
                    <label>User Tags (separados por comas)</label>
                    <input
                      type="text"
                      [(ngModel)]="requestForm().userTags"
                      name="userTags"
                      class="form-control"
                      placeholder="must watch, award winner">
                  </div>
                </div>
              }

              <!-- URL INPUT MODE -->
              @if (formInputMode() === 'url') {
                <div class="form-section">
                  <h4><span class="material-icons">link</span> Importar desde URL</h4>

                  <div class="form-group">
                    <label>URL de TMDb, IMDb o MovieLens</label>
                    <div class="url-input-group">
                      <input
                        type="url"
                        [(ngModel)]="requestForm().importUrl"
                        name="importUrl"
                        class="form-control"
                        placeholder="https://www.themoviedb.org/movie/862"
                        [disabled]="isLoadingFromUrl()">
                      <button
                        type="button"
                        class="btn-import"
                        (click)="importFromUrl()"
                        [disabled]="!requestForm().importUrl || isLoadingFromUrl()">
                        @if (isLoadingFromUrl()) {
                          <span class="material-icons spinning">refresh</span>
                          Cargando...
                        } @else {
                          <span class="material-icons">download</span>
                          Importar
                        }
                      </button>
                    </div>
                    <small>
                      <strong>Nota:</strong> Pega la URL de TMDb, IMDb o MovieLens y los datos se obtendrán automáticamente desde nuestra API en los campos editables.
                    </small>
                  </div>

                  @if (urlImportError()) {
                    <div class="alert alert-error">
                      <span class="material-icons">error</span>
                      {{ urlImportError() }}
                    </div>
                  }

                  @if (urlImportSuccess()) {
                    <div class="alert alert-success">
                      <span class="material-icons">check_circle</span>
                      Datos obtenidos exitosamente desde la API. Revisa y edita los campos según sea necesario.
                    </div>
                  }

                  <!-- Los campos editables se muestran después de importar -->
                  @if (urlImportSuccess()) {
                    <!-- Type Selection -->
                    <div class="form-section">
                      <h4><span class="material-icons">settings</span> Tipo de Solicitud</h4>

                      <div class="form-row">
                        <div class="form-group">
                          <label>Tipo de Solicitud *</label>
                          <select [(ngModel)]="requestForm().requestType" name="requestType" class="form-control">
                            <option value="add">Agregar nueva película</option>
                            <option value="edit">Editar película existente</option>
                          </select>
                        </div>
                      </div>
                    </div>

                    <!-- Basic Information -->
                    <div class="form-section">
                      <h4><span class="material-icons">info</span> Información Básica (Editable)</h4>

                      <div class="form-row">
                        <div class="form-group">
                          <label>Título *</label>
                          <input
                            type="text"
                            [(ngModel)]="requestForm().title"
                            name="title"
                            class="form-control"
                            placeholder="Título de la película"
                            required>
                        </div>

                        <div class="form-group">
                          <label>Año *</label>
                          <input
                            type="number"
                            [(ngModel)]="requestForm().year"
                            name="year"
                            class="form-control"
                            min="1800"
                            [max]="2100"
                            required>
                        </div>
                      </div>

                      <div class="form-group">
                        <label>Sinopsis</label>
                        <textarea
                          [(ngModel)]="requestForm().overview"
                          name="overview"
                          class="form-control"
                          rows="4"
                          placeholder="Descripción de la película..."></textarea>
                      </div>

                      <div class="form-group">
                        <label>Director</label>
                        <input
                          type="text"
                          [(ngModel)]="requestForm().director"
                          name="director"
                          class="form-control"
                          placeholder="Nombre del director">
                      </div>

                      <div class="form-row">
                        <div class="form-group">
                          <label>Presupuesto (USD)</label>
                          <input
                            type="number"
                            [(ngModel)]="requestForm().budget"
                            name="budget"
                            class="form-control"
                            min="0"
                            placeholder="Ej: 150000000">
                        </div>

                        <div class="form-group">
                          <label>Recaudación (USD)</label>
                          <input
                            type="number"
                            [(ngModel)]="requestForm().revenue"
                            name="revenue"
                            class="form-control"
                            min="0"
                            placeholder="Ej: 500000000">
                        </div>
                      </div>

                      <div class="form-group">
                        <label>Elenco (separados por comas)</label>
                        <input
                          type="text"
                          [(ngModel)]="requestForm().cast"
                          name="cast"
                          class="form-control"
                          placeholder="Actor 1, Actor 2, Actor 3">
                      </div>

                      <div class="form-group">
                        <label>URL del Elenco</label>
                        <input
                          type="url"
                          [(ngModel)]="requestForm().castUrl"
                          name="castUrl"
                          class="form-control"
                          placeholder="https://...">
                      </div>

                      <div class="form-group">
                        <label>URL del Póster</label>
                        <input
                          type="url"
                          [(ngModel)]="requestForm().posterUrl"
                          name="posterUrl"
                          class="form-control"
                          placeholder="https://image.tmdb.org/t/p/w500/...">
                      </div>

                      <div class="form-group">
                        <label>Géneros * (Selecciona al menos uno)</label>
                        <div class="genre-dropdown">
                          <button
                            type="button"
                            class="genre-dropdown-toggle"
                            (click)="toggleGenreDropdown()">
                            <span>{{ getSelectedGenresText() }}</span>
                            <span class="material-icons">{{ genreDropdownOpen() ? 'expand_less' : 'expand_more' }}</span>
                          </button>
                          @if (genreDropdownOpen()) {
                            <div class="genre-dropdown-menu">
                              @for (genre of availableGenres; track genre) {
                                <label class="genre-dropdown-item">
                                  <input
                                    type="checkbox"
                                    [checked]="requestForm().genres.includes(genre)"
                                    (change)="toggleGenre(genre)">
                                  <span>{{ genre }}</span>
                                </label>
                              }
                            </div>
                          }
                        </div>
                        @if (requestForm().genres.length > 0) {
                          <div class="selected-genres">
                            @for (genre of requestForm().genres; track genre) {
                              <span class="selected-genre-badge">
                                {{ genre }}
                                <button
                                  type="button"
                                  class="remove-genre"
                                  (click)="toggleGenre(genre)">
                                  ×
                                </button>
                              </span>
                            }
                          </div>
                        }
                      </div>

                    </div>
                  }
                </div>
              }

            </div>

            <div class="form-actions">
              <button type="button" class="btn-secondary" (click)="toggleRequestForm()">
                Cancelar
              </button>
              <button type="submit" class="btn-primary" [disabled]="isSubmitting()">
                {{ isSubmitting() ? 'Enviando...' : 'Enviar Solicitud' }}
              </button>
            </div>
          </form>
        </div>
      }

      <!-- Requests List -->
      <div class="requests-list">
        @if (isLoadingRequests()) {
          <div class="loading">Cargando solicitudes...</div>
        } @else if (myRequests().length === 0) {
          <div class="empty-state">
            <p>No tienes solicitudes aún</p>
          </div>
        } @else {
          @for (request of myRequests(); track request.requestId) {
            <div class="request-card">
              <div class="request-header">
                <h3>{{ request.movieData.title }}</h3>
                <span class="badge" [ngClass]="getStatusBadgeClass(request.status)">
                  {{ getStatusText(request.status) }}
                </span>
              </div>
              <div class="request-details">
                <p><strong>Tipo:</strong> {{ request.requestType === 'add' ? 'Agregar' : 'Editar' }}</p>
                <p><strong>Año:</strong> {{ request.movieData.year }}</p>
                <p><strong>Géneros:</strong> {{ request.movieData.genres.join(', ') }}</p>
                <p><strong>Fecha:</strong> {{ request.createdAt }}</p>
                @if (request.reviewNote) {
                  <p class="review-note"><strong>Nota del revisor:</strong> {{ request.reviewNote }}</p>
                }
              </div>
            </div>
          }
        }
      </div>
    </div>
  }

  <!-- RATINGS TAB -->
  @if (activeTab() === 'ratings') {
    <div class="tab-content">
      <div class="section-header">
        <h2>Mis Calificaciones</h2>
        <p class="rating-count">Total: {{ ratingsTotal() }}</p>
      </div>

      <!-- Filters -->
      <div class="filters-card">
        <div class="filter-row">
          <div class="filter-group">
            <label>Buscar película</label>
            <input
              type="text"
              [(ngModel)]="ratingsFilter().search"
              (ngModelChange)="onRatingFilterChange()"
              class="form-control"
              placeholder="Buscar por título...">
          </div>
          <div class="filter-group">
            <label>Rating mínimo</label>
            <select
              [(ngModel)]="ratingsFilter().minRating"
              (ngModelChange)="onRatingFilterChange()"
              class="form-control">
              <option [value]="0">Todos</option>
              <option [value]="1">★ 1+</option>
              <option [value]="2">★ 2+</option>
              <option [value]="3">★ 3+</option>
              <option [value]="4">★ 4+</option>
              <option [value]="5">★ 5</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Ratings Table -->
      @if (isLoadingRatings()) {
        <div class="loading">Cargando calificaciones...</div>
      } @else if (myRatings().length === 0) {
        <div class="empty-state">
          <p>No tienes calificaciones aún</p>
        </div>
      } @else {
        <div class="table-responsive">
          <table class="ratings-table">
            <thead>
              <tr>
                <th>Película</th>
                <th>Géneros</th>
                <th>Mi Calificación</th>
                <th>Fecha</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              @for (rating of paginatedRatings(); track rating.movieId) {
                <tr>
                  <td>
                    <div class="movie-cell">
                      @if (rating.movie?.posterPath) {
                        <img [src]="rating.movie?.posterPath" [alt]="rating.movie?.title" class="mini-poster">
                      }
                      <span>{{ rating.movie?.title || 'Película ' + rating.movieId }}</span>
                    </div>
                  </td>
                  <td>
                    <div class="genres-cell">
                      @for (genre of (rating.movie?.genres || []).slice(0, 2); track genre) {
                        <span class="genre-tag">{{ genre }}</span>
                      }
                    </div>
                  </td>
                  <td>
                    @if (editingRating() === rating.movieId) {
                      <div class="rating-editor">
                        <app-star-rating
                          [rating]="editRatingValue()"
                          [readonly]="false"
                          (ratingChange)="editRatingValue.set($event)">
                        </app-star-rating>
                      </div>
                    } @else {
                      <app-star-rating [rating]="rating.rating" [readonly]="true"></app-star-rating>
                    }
                  </td>
                  <td>{{ formatDate(rating.timestamp) }}</td>
                  <td>
                    <div class="actions-cell">
                      @if (editingRating() === rating.movieId) {
                        <button class="btn-small btn-success" (click)="saveRating(rating.movieId)">
                          ✓
                        </button>
                        <button class="btn-small btn-secondary" (click)="cancelEditRating()">
                          ✕
                        </button>
                      } @else {
                        <button
                          class="btn-small btn-edit"
                          (click)="startEditRating(rating.movieId, rating.rating)">
                          <span class="material-icons">edit</span>
                        </button>
                        <button
                          class="btn-small btn-delete"
                          (click)="deleteRating(rating.movieId)">
                          <span class="material-icons">delete</span>
                        </button>
                      }
                    </div>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        <div class="pagination">
          <button
            class="btn-pagination"
            (click)="previousPage()"
            [disabled]="ratingsPage() === 0">
            ← Anterior
          </button>
          <span class="pagination-info">
            Página {{ ratingsPage() + 1 }} de {{ totalPages() }}
          </span>
          <button
            class="btn-pagination"
            (click)="nextPage()"
            [disabled]="ratingsPage() >= totalPages() - 1">
            Siguiente →
          </button>
        </div>
      }
    </div>
  }
</div>
